CXX = g++
CXXFLAGS = -std=c++11 -Wall -IShared -IServer

# --- سورس‌ها ---
SRC_SERVER = $(wildcard Server/*.cpp) $(wildcard Shared/*.cpp)
SRC_CLIENT = $(wildcard Client/*.cpp) $(wildcard Shared/*.cpp)

# --- آبجکت‌ها ---
OBJ_SERVER = $(SRC_SERVER:.cpp=.o)
OBJ_CLIENT = $(SRC_CLIENT:.cpp=.o)

# --- خروجی‌ها ---
BIN_SERVER = Server/Server.out
BIN_CLIENT = Client/Client.out

# --- هدف پیش‌فرض ---
all: $(BIN_SERVER) $(BIN_CLIENT)

# --- لینک سرور ---
$(BIN_SERVER): $(OBJ_SERVER)
	$(CXX) $(CXXFLAGS) -o $@ $(OBJ_SERVER)

# --- لینک کلاینت ---
$(BIN_CLIENT): $(OBJ_CLIENT)
	$(CXX) $(CXXFLAGS) -o $@ $(OBJ_CLIENT)

# --- قانون عمومی ساخت فایل‌های .o از .cpp ---
%.o: %.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@

# --- پاک کردن فایل‌های موقتی ---
clean:
	rm -f Server/*.o Client/*.o Shared/*.o $(BIN_SERVER) $(BIN_CLIENT)


# اجرای کلاینت و سرور در tmux
run: all
	@if tmux ls 2>/dev/null | grep -q "mysession"; then \
		tmux kill-session -t mysession; \
	fi
	@tmux new-session -d -s mysession

	# تقسیم پنجره: سمت چپ برای سرور، سمت راست برای بقیه
	@tmux split-window -h -t mysession:0

	# سمت چپ: سرور
	@tmux send-keys -t mysession:0.0 'bash -c "./Server/Server.out 8080 || echo Server failed"' C-m
	@sleep 5

	# سمت راست: split به دو - بالا evaluator، پایین کلاینت‌ها
	@tmux split-window -v -t mysession:0.1

	# تقسیم پایین برای چند کلاینت
	@tmux split-window -v -t mysession:0.2
	# @tmux split-window -v -t mysession:0.3

	# اجرای کلاینت‌ها
	@tmux send-keys -t mysession:0.1 'bash -c "./Client/Client.out 8080"' C-m
	@tmux send-keys -t mysession:0.2 'bash -c "./Client/Client.out 8080"' C-m
	@tmux send-keys -t mysession:0.3 'bash -c "./Client/Client.out 8080"' C-m

	# اتصال به جلسه
	@tmux attach-session -t mysession
